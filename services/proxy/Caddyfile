{
  # Logging en JSON dans un fichier dédié
  log access-json {
    output file /var/log/access-foo.json
    format json
  }
}

# Redirection HTTP → HTTPS
:80 {
  redir https://{host}{uri} permanent
}

# Bloc principal avec domaines autorisés
https://localhost, https://{$HOSTNAME}, https://{$IP} {
  tls internal
  log {
    output file /var/log/caddy.log
    format console
  }

  # Route WebSocket (doit venir en haut si elle est spécifique)
  handle_path /ws/game {
    reverse_proxy game-service:3003
  }

  # API backend
  handle /auth/* {
    reverse_proxy auth-service:3001
  }

  handle /game/* {
    reverse_proxy game-service:3003
  }

  handle /stats/* {
    reverse_proxy stats-service:3002
  }

  handle /user/* {
    reverse_proxy user-service:3004
  }

  # Route par défaut : frontend SPA
  handle {
    reverse_proxy frontend:5173
  }
}
